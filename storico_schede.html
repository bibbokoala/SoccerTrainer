<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
   <link href="css/bootstrap.min.css" rel="stylesheet">
   <!-- CSS FOR TOGGLE LEFT MENU -->
     <link href='http://fonts.googleapis.com/css?family=Exo+2:400,600,300,900' rel='stylesheet' type='text/css'>
     <link href="css/navbar-static-top.css" rel="stylesheet">
     <link rel="stylesheet" href="font-awesome/css/font-awesome.min.css">
   <!-- END CSS FOR TOGGLE LEFT MENU -->
   <link href="css/custom.css" rel="stylesheet">
<script src="phonegap.js"></script>
   <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script> -->
   <script src="js/jquery.min.js"></script>
   <!-- <script src="js/menu.js"></script>-->
 <script type="text/javascript" charset="utf-8">
    // Call onDeviceReady when Cordova is loaded.
    // At this point, the document has loaded but cordova-1.8.1.js has not.
    // When Cordova is loaded and talking with the native device,
    // it will call the event `deviceready`.
    function onLoad() {
        document.addEventListener("deviceready", onDeviceReady, false);
        //alert("onload");
    }
    // Cordova is loaded and it is now safe to make calls Cordova methods
    function onDeviceReady() {
        document.addEventListener("offline", onOffline, false);
        document.addEventListener("online", onOnline, false);
        if (device.model!=null)
        {
          localStorage.setItem("duuid", device.uuid);
          localStorage.setItem("dmodel", device.model);
          localStorage.setItem("dplatform", device.platform);
          localStorage.setItem("dversion", device.version);
        }
        //alert("onDeviceReady");
    }
    // Handle the offline event
    function onOffline() {
      $("#offline-alert").alert();
      $("#offline-alert").fadeTo(2000, 500).slideUp(500, function(){
        $("#offline-alert").alert('close');
      });   
      //alert("Il dispositivo e' OffLine\nQuesta App richiede una connessione internet!");
      //btn_login disabled
      $('#btn_login').addClass( "disabled" );
    }
    // Handle the online event
    function onOnline() {
      $("#online-alert").alert();
      $("#online-alert").fadeTo(2000, 500).slideUp(500, function(){
        $("#online-alert").alert('close');
      });   
      //alert("Il dispositivo e' OnLine!");
      //btn_login enabled!
      $('#btn_login').removeClass( "disabled" );
    }
    // Handle the back browser button
    document.addEventListener("backbutton", onBackKeyDown, false);
    function onBackKeyDown() {
      if (confirm("Chiudere l'applicazione?")) {
        navigator.app.exitApp();
      }
    }

  function debugLocalStorage(){
    console.log("***** START debugLocalStorage *****");
    for (var i = 0; i < localStorage.length; i++){
      console.log(i + ") [localStorage] chiave: " + localStorage.key(i) + " - valore: " + localStorage.getItem(localStorage.key(i)));
    }
    console.log("*****  END debugLocalStorage  *****");
  }

</script>
<script>
//var db = openDatabase('GeoNavDB', '1.0', 'GeoNav App DB', 3 * 1024 * 1024);
$.fn.serializeObject = function()
{
    var o = {};
    var a = this.serializeArray();
    $.each(a, function() {
        if (o[this.name] !== undefined) {
            if (!o[this.name].push) {
                o[this.name] = [o[this.name]];
            }
            o[this.name].push(this.value || '"');
        } else {
            o[this.name] = this.value || '"';
        }
    });
    return o;
};

function delPlayerCard(id, id_calciatore, id_card){
  if (confirm("Vuoi veramente eliminare la scheda?")) {
    var url = "http://linkin.it/Projects/SoccerTrainer/STDelPlayerCard.php";
    console.log("url: " + url + "- id_calciatore: " + id_calciatore + "- id_card: " + id_card );
    alert("url: " + url + "- id_calciatore: " + id_calciatore + "- id_card: " + id_card );
    $.ajax({
      url: url,
      cache : false,
      dataType : "json",
      data : { id_card: id_card ,  id_calciatore: id_calciatore },
      success: function(s){
        var result_insert = s;
        console.log(JSON.stringify(result_insert));
        window.location = "storico_schede.html?id=" + id ;
      } 
    });
  }
}

  $(document).ready(function() {

    $("#logo_big").click(function(){
      window.location = "index.html";
    });

    $('#btn_exit').click(function() {
      if (confirm("Chiudere l'applicazione?")) {
        navigator.app.exitApp();
      }
    });

    $( "#matricola" ).keydown(function( event ) {
      if ( event.which == 13 ) {
        event.preventDefault();
        $( "#password" ).focus();
      }
      console.log("Handler for .keydown() called ");
      console.log("event: "+event.which);
    });

    $( "#matricola" ).change(function(){
        this.value = this.value.toLowerCase();
        //DEBUG alert(this.value);
    });


    $( "#password" ).keydown(function( event ) {
      if ( event.which == 13 ) {
        event.preventDefault();
        $("#btn_login").click();
      }
    });

    $("#btn_logout").click(function(){
      if (confirm("Effettuare il Log-out?")) {
        localStorage.clear();
        console.log("btn_logout: "+localStorage.getItem("login"));
        window.location.href = 'index.html';
      }
    });

    $('#btn_indietro').click(function() {
      window.location.href = 'home.html';
    });

    Object.size = function(obj) {
        var size = 0, key;
        for (key in obj) {
            if (obj.hasOwnProperty(key)) size++;
        }
        return size;
    };

    function getPlayersCards(idListaPlayer, playerId){
      //DEBUG alert("getPlayersCards");
      var matricola = localStorage.getItem("matricola");
      if (matricola==null)
          matricola="simone";
      var random = Math.random();
      var xmlhttp = new XMLHttpRequest();
      var url="http://linkin.it/Projects/SoccerTrainer/STGetPlayersCard.php?matricola="+matricola+"&id_player="+playerId+"&random="+random;
      console.log("url:"+url);
      //DEBUG alert("url:"+url);
      xmlhttp.onreadystatechange=function() {
          if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
              var result = xmlhttp.responseText;
              localStorage.setItem("lista_schede", result);
              var lista = JSON.parse(result);
              var size = Object.size(lista);
              //DEBUG alert("lista: " + lista);
              console.log("lista: " + lista);
              if (size>0){
                //NON LO SO SE SERVE localStorage.setItem("lista_schede", lista);
                var html = "<div class='alert alert-calciatore' role='alert'>";
                //DEBUG html += "<pre>" + JSON.stringify(lista) + "</pre>";
                //renderizzare la scheda...
                html += "<h3>LISTA SCHEDE</h3>";
                for (i=0; i<lista.length; i++) { 
                  html += "<div class='scheda' id ='"+lista[i].id_scheda+"' >";
                  html += "<a href='./visualizza_scheda.html?id=" +lista[i].id_scheda+ "' class='btn btn-lg btn-primary' style='width: 150px;'>";
                  html += "<font style='font-size:13px;'>"+ lista[i].data_gara + " </font>";
                  html += "</a>";
                  html += "&nbsp;";
                  html += "<a href='javascript:void(0);' onclick='delPlayerCard("+idListaPlayer+","+lista[i].id_calciatore+","+lista[i].id_scheda+");' class='btn btn-lg btn-danger' >";
                  html += "<span class='glyphicon glyphicon-minus' aria-hidden='true' ></span> ";
                  html += "</a>";
                  html += "</div>";        
                  html += "&nbsp;";
                }
                html += "</div>";
                $("#lista_schede").html(html);
              }
              else
                $("#lista_schede").html("<div class='alert alert-calciatore' role='alert'>NON CI SONO SCHEDE</div>");
          }
      }
      xmlhttp.open("GET", url, true);
      xmlhttp.send();
    }

    function infoPlayer(){
      var last_params = window.location.search.substr(1);
      var items = last_params.split("=");
      var i = items[1];
      console.log("parametro - id=" + i );
      var lista_calciatori = JSON.parse( localStorage.getItem("lista_calciatori") );
      var html = "<div class='alert alert-calciatore' role='alert'>" + 
                 "<font size='6'><B>" + lista_calciatori[i].nome + " " + lista_calciatori[i].cognome + "</B></font><br>" + 
                 //"[id: " + lista_calciatori[i].id_calciatore + "]<br>" + 
                 "nato il <b>" + lista_calciatori[i].data_nascita + "</b> a <b>" + lista_calciatori[i].luogo_nascita + "</b> " + 
                 "nazionalit&agrave;: <b>" + lista_calciatori[i].nazionalita + "</b> " + 
                 "altezza <b>" + lista_calciatori[i].altezza_cm + "</b> cm " + 
                 "peso <b>" + lista_calciatori[i].peso_kg + "</b> kg " + 
                 "</div>";
      $("#dati_calciatore").html(html);
      getPlayersCards(i, lista_calciatori[i].id_calciatore);
    }
    infoPlayer();

  });  
</script>

</head>
<body onload="onLoad()">
    <!-- Static navbar -->
    <nav class="navbar navbar-default navbar-fixed-top gradienti">
      <div class="container">
        <div class="navbar-header">
          <!-- solo per la pagina index.html NON ESISTE IL MENU ed il logo ha un margine di 40 pixel -->
          <div class="navbar-header" style="line-height: 56px;" id="testata" >
            <b id='logo_big' >Soccer Trainer</b>
            <a id="btn_exit" type="button" class='.navbar-toggle pull-right' style="color: #FFF;" >
               <span class="glyphicon glyphicon-remove" aria-hidden="true" style="color: #FFF;" ></span>&nbsp;&nbsp;&nbsp;
            </a>
            <a id="btn_logout" type="button" class='.navbar-toggle pull-right' style="color: #FFF;" >
               <span class="  glyphicon glyphicon-log-out" aria-hidden="true" style="color: #FFF;" ></span>&nbsp;&nbsp;&nbsp;
            </a>
          </div>
        </div>
      </div>
    </nav>
    <!-- <div class="container-fluid" style="max-width: 540px;" id="fluido" > -->
    <div class="container-fluid" id="fluido" >
      <div class="row">
        <div class="col-sm-12 col-sm-offset-0 col-md-12 col-md-offset-0 main" id="contenuto" >
          <div id='dati_calciatore'></div><br>
          <div id='lista_schede'></div><br>
          <button id='btn_indietro' class='btn btn-lg btn-warning' >INDIETRO</button> 
        </div> <!-- close <div class="col-sm-12 col-sm-offset-0 col-md-12 col-md-offset-0 main"> -->
      </div> <!-- close div row --> 
    </div> <!-- close div container-fluid -->
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="js/bootstrap.min.js"></script>
    <script>
    debugLocalStorage();
    </script>
    </body>
</html>